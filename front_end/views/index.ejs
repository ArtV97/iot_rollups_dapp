<!DOCTYPE html>
<html>

<head lang="pt-br">
	<title>Cartesi Rollups Dapp</title>
	<meta charset="utf-8">

    <!-- Bootstrap -->
	<link href="bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Font Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</head>

<body id="home">
	<div class="container">
        <form>
            <div class="mb-3">
                <label for="selectedAddress" class="form-label">From Address</label>
                <select id="selectedAddress" class="form-select">
                  <option selected value=""> Choose Address</option>
                  <% for(var i = 1; i < accounts.length; i++){ %>
                    <option>
                            <%= accounts[i] %>
                    </option>
                    <% } %>
                </select>
            </div>

            <div class="mb-3 row" style="display: none;">
                <div class="col-6">
                    <label for="bus_id" class="form-label">Bus Id</label>
                    <input type="text" class="form-control" id="bus_id">    
                </div>

                <div class="col-6">
                    <label for="stations" class="form-label">Number of Stations</label>
                    <input type="text" class="form-control" onchange="changeTableHeader()" value="0" id="stations">
                </div>
            </div>

            <table id="scheduleTable" class="table table-striped">
                <thead>
                </thead>
                
                <tbody>
                </tbody>
            </table>

            <div id="buttonsDiv" style="display:none">
                <button type="button" class="btn btn-primary" onclick="addRow()"><i class="bi bi-plus-circle"></i></button>
                <button type="button" class="btn btn-danger" onclick="delRow()"><i class="bi bi-dash-circle"></i></button>
                <hr>
            </div>
    
            <div class="mb-3">
                <label for="scheduleFile" class="form-label">Load Schedule From JSON file</label>
                <input class="form-control" type="file" accept=".json" id="scheduleFile" onchange="loadFileContent()">
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary text-center" onclick="formSubmit()">Submit</button>
            </div>
        </form>
    </div>
</body>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script>
    let car_count = 0
    let tableColumns = undefined
    let textFromFileLoaded = undefined


    function changeTableHeader() {
        let table = document.getElementById('scheduleTable')
        let theadRef = table.getElementsByTagName('thead')[0];
        tableColumns = Number(document.getElementById("stations").value)

        if (tableColumns == 0) {
            let tbodyRef = table.getElementsByTagName('tbody')[0];
            
            theadRef.innerHTML = ``
            tbodyRef.innerHTML = ``
            
            $("#buttonsDiv").toggle()
            return
        }
        
        var theadHTML = `
            <tr>
                <th scope="col">Schedule</th>
        `
        for (let index = 0; index < tableColumns; index++) {
            const th = `<th scope="col">Station ${index}</th>\n`
            theadHTML = theadHTML + th
        }

        theadHTML = theadHTML + `</tr>`

        theadRef.innerHTML = theadHTML
        $("#buttonsDiv").toggle()
    }


    function addRow() {
        car_count++

        let table = document.getElementById('scheduleTable')
        let tbodyRef = table.getElementsByTagName('tbody')[0];

        // Insert a row at the end of table
        let newRow = tbodyRef.insertRow();

        //for (let c=0, m=table.rows[0].cells.length; c < m; c++) {
        for (let c=0; c < tableColumns+1; c++) { // +1 because of the th
            // Insert a cell at the end of the row
            let newCell = newRow.insertCell();

            // Append a text node to the cell
            let rowHTML
            if (c == 0) {
                rowHTML = `<th scope="row">Car ${car_count}</th>`
            }
            else {
                rowHTML = `<td><input id="car-${car_count}|station-${c}" type="text"></input></td>`
            }
            newCell.innerHTML = rowHTML
        }
    }

    function delRow() {
        car_count--

        let table = document.getElementById('scheduleTable')
        let tbodyRef = table.getElementsByTagName('tbody')[0];

        tbodyRef.deleteRow(-1)
    }


    function loadFileContent(){
        var fileToLoad = document.getElementById("scheduleFile").files[0];

        var fileReader = new FileReader();
        fileReader.onload = function(fileLoadedEvent){
            textFromFileLoaded = fileLoadedEvent.target.result;
            console.log(textFromFileLoaded)
            //document.getElementById("scheduleFile").value = textFromFileLoaded;
        };

        fileReader.readAsText(fileToLoad, "UTF-8");
    }

 
    function formSubmit() {
        const fromAddress = document.getElementById("selectedAddress").value
        let body = undefined

        if (fromAddress == "") {
            alert("Error: Please select an Address.")
            return
        }

        if (textFromFileLoaded) {
            try {
                json = JSON.parse(textFromFileLoaded)
                if (!json.hasOwnProperty("bus_id")) { throw "JSON Error: Missing \"bus_id\" key." }
                if (!json.hasOwnProperty("route")) { throw "JSON Error: Missing \"route\" key." }
                if (!json.hasOwnProperty("stations")) { throw "JSON Error: Missing \"stations\" key." }
                if (!json.hasOwnProperty("schedule")) { throw "JSON Error: Missing \"schedule\" key." }

                body = textFromFileLoaded
            }
            catch (error) {
                alert(error)
                return
            }
        }

        if (!body) {
            alert("Error: Nothing to send.")
            return
        }

        $.ajax({
            url:"/submit",
            type: "POST",
            async: false,
            data : {
                fromAddress: document.getElementById("selectedAddress").value,
                data: textFromFileLoaded
            },
            cache : false,
            success : function (res) {
                if(res["success"]){
                    alert(res["result"]);
                }
                else if (!res["success"]) {
                    alert(res["result"])
                }
            },
            error : function () {
                // some error handling part
                alert("Request Failed");
            }
        });
    };
</script>
</html>